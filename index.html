<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Market Research — Live Board</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-white text-gray-900">
  <header class="px-6 py-4 border-b sticky top-0 bg-white/90 backdrop-blur z-50">
    <div class="max-w-6xl mx-auto flex items-center justify-between">
      <h1 class="text-2xl font-bold">Market Research — Live Board</h1>
      <div id="last-updated" class="text-sm text-gray-500">Loading…</div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-6 py-8 space-y-12">
    <!-- Topics Filter -->
    <section id="topics-section" class="hidden">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-xl font-semibold">Topics</h2>
        <button id="clear-topics" class="text-sm text-blue-600 hover:underline">Clear</button>
      </div>
      <div id="topics-row" class="flex flex-wrap gap-2"></div>
    </section>

    <!-- Top 6 news -->
    <section>
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-xl font-semibold">Top News & Analysis</h2>
      </div>
      <div id="news-list" class="grid md:grid-cols-2 gap-6"></div>
    </section>

    <!-- Funding & M&A -->
    <section>
      <h2 class="text-xl font-semibold mb-3">Funding & M&A</h2>
      <div id="funding-list" class="grid md:grid-cols-2 gap-6"></div>
    </section>

    <!-- Hashtags -->
    <section>
      <h2 class="text-xl font-semibold mb-3">Trending Hashtags</h2>
      <div id="hashtags" class="flex flex-wrap gap-2"></div>
    </section>
  </main>

  <!-- Ticker -->
  <div class="w-full border-t">
    <div class="overflow-hidden whitespace-nowrap py-2" id="ticker-wrap">
      <div id="ticker" class="inline-block animate-marquee"></div>
    </div>
  </div>

  <style>
    @keyframes marquee { 0% {transform: translateX(100%);} 100% {transform: translateX(-100%);} }
    /* Slower by default; duration is tuned in JS based on text length */
    .animate-marquee { animation: marquee var(--marquee-duration, 90s) linear infinite; }
    /* Pause when hovering so people can read */
    #ticker-wrap:hover .animate-marquee { animation-play-state: paused; }

    .clamp-3 { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
    .chip { padding: 0.25rem 0.75rem; border-radius: 9999px; background: #f3f4f6; font-size: .875rem; cursor: pointer; }
    .chip:hover { background: #e5e7eb; }
    .chip-active { background: #2563eb; color: white; }
  </style>

  <script>
    // ---------- State ----------
    let STATE = { raw: null, selectedTopics: new Set() };

    // ---------- Helpers ----------
    function topicChip(topic) {
      const btn = document.createElement('button');
      btn.className = 'chip';
      btn.textContent = topic;
      btn.onclick = () => {
        STATE.selectedTopics.has(topic) ? STATE.selectedTopics.delete(topic) : STATE.selectedTopics.add(topic);
        render();
      };
      return btn;
    }
    function setActive(el, active) { el.classList.toggle('chip-active', active); }
    function matchesTopics(item) {
      if (STATE.selectedTopics.size === 0) return true;
      const topics = item.topics || []; // tolerate missing topics
      return topics.some(t => STATE.selectedTopics.has(t));
    }

    // ---------- Renderers ----------
    function renderTopicsBar(data) {
      const section = document.getElementById('topics-section');
      const row = document.getElementById('topics-row');
      row.innerHTML = '';

      const list = data.topics_available || [];
      if (list.length === 0) { section.classList.add('hidden'); return; }
      section.classList.remove('hidden');

      list.forEach(t => {
        const chip = topicChip(t);
        setActive(chip, STATE.selectedTopics.has(t));
        row.appendChild(chip);
      });
    }

    function renderLists(data) {
      // Top news
      const newsEl = document.getElementById('news-list');
      newsEl.innerHTML = '';
      (data.top_news || []).filter(matchesTopics).slice(0, 6).forEach(item => {
        const card = document.createElement('article');
        card.className = 'border rounded-lg p-4 hover:shadow transition';
        card.innerHTML = `
          <a class="block" href="${item.link}" target="_blank" rel="noopener">
            <h3 class="font-semibold mb-2">${item.title}</h3>
            <p class="text-sm text-gray-700 mb-2 clamp-3">${item.summary || ''}</p>
            <div class="text-xs text-gray-500">${new Date(item.isoDate).toLocaleString()} • ${item.source || ''}</div>
            ${(item.topics||[]).length ? `<div class="mt-2 flex flex-wrap gap-2">${(item.topics||[]).map(t=>`<span class="text-xs px-2 py-0.5 rounded-full bg-gray-100">${t}</span>`).join('')}</div>` : ''}
          </a>`;
        newsEl.appendChild(card);
      });

      // Funding
      const fundEl = document.getElementById('funding-list');
      fundEl.innerHTML = '';
      (data.funding_ma || []).filter(matchesTopics).slice(0, 8).forEach(item => {
        const card = document.createElement('article');
        card.className = 'border rounded-lg p-4 hover:shadow transition';
        card.innerHTML = `
          <a class="block" href="${item.link}" target="_blank" rel="noopener">
            <h3 class="font-semibold mb-2">${item.title}</h3>
            <p class="text-sm text-gray-700 mb-2 clamp-3">${item.summary || ''}</p>
            <div class="text-xs text-gray-500">${new Date(item.isoDate).toLocaleString()} • ${item.source || ''}</div>
            ${(item.topics||[]).length ? `<div class="mt-2 flex flex-wrap gap-2">${(item.topics||[]).map(t=>`<span class="text-xs px-2 py-0.5 rounded-full bg-gray-100">${t}</span>`).join('')}</div>` : ''}
          </a>`;
        fundEl.appendChild(card);
      });

      // Hashtags
      const tagsEl = document.getElementById('hashtags');
      tagsEl.innerHTML = '';
      (data.hashtags || []).slice(0, 20).forEach(tag => {
        const a = document.createElement('a');
        a.href = tag.url; a.target = '_blank'; a.rel = 'noopener';
        a.className = 'px-3 py-1 rounded-full bg-gray-100 hover:bg-gray-200 text-sm';
        a.textContent = tag.label;
        tagsEl.appendChild(a);
      });

      // Ticker
      const ticker = document.getElementById('ticker');
      ticker.innerHTML = '';
      (data.ticker || []).forEach(t => {
        const span = document.createElement('span');
        span.className = 'mx-6 text-sm';
        span.innerHTML = `<a href="${t.link}" target="_blank" class="hover:underline">${t.text}</a>`;
        ticker.appendChild(span);
      });

      // Tune marquee speed to content length (slower for longer) + set pause-on-hover via CSS above
      const totalChars = Array.from(ticker.querySelectorAll('span')).reduce((n, el) => n + (el.innerText || '').length, 0);
      const secs = Math.max(50, Math.min(140, Math.round(totalChars / 16))); // ~slower baseline
      ticker.style.setProperty('--marquee-duration', `${secs}s`);

      // Last updated
      document.getElementById('last-updated').textContent = 'Updated ' + new Date(data.generated_at).toLocaleString();
    }

    function render() { if (!STATE.raw) return; renderTopicsBar(STATE.raw); renderLists(STATE.raw); }

    // ---------- Boot ----------
    document.getElementById('clear-topics').addEventListener('click', () => { STATE.selectedTopics.clear(); render(); });

    (async function loadData(){
      try {
        const resp = await fetch('./data/news.json?cb=' + Date.now());
        const data = await resp.json();
        STATE.raw = data;
        render();
      } catch (e) {
        console.error(e);
        document.getElementById('last-updated').textContent = 'Failed to load data';
      }
    })();
  </script>
</body>
</html>
